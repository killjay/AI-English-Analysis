<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>English Speaking Assessment with AI Analysis</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        /* Prevent text selection on buttons and interactive elements */
        button, .btn {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }

        /* Smooth scrolling for mobile */
        html {
            scroll-behavior: smooth;
            -webkit-text-size-adjust: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', sans-serif;
            background: #fafbfc;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: #1a1a1a;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }

        .container {
            background: #ffffff;
            border-radius: 16px;
            padding: 48px;
            box-shadow: 0 4px 32px rgba(0, 0, 0, 0.08);
            max-width: 800px;
            width: 100%;
            min-height: 600px;
            display: flex;
            flex-direction: column;
            border: 1px solid #f0f0f0;
        }

        .header {
            text-align: center;
            margin-bottom: 32px;
        }

        .header h1 {
            color: #1a1a1a;
            font-size: 2.5rem;
            margin-bottom: 12px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header p {
            color: #6b7280;
            font-size: 1.125rem;
            font-weight: 400;
            line-height: 1.5;
        }

        .settings-btn {
            position: fixed;
            top: 24px;
            right: 24px;
            background: #8b5cf6;
            color: white;
            border: none;
            border-radius: 12px;
            width: 48px;
            height: 48px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.25);
            z-index: 1000;
        }

        .settings-btn:hover {
            background: #7c3aed;
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.35);
        }

        .back-btn {
            position: fixed;
            top: 24px;
            right: 24px;
            background: #8b5cf6;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s ease;
            display: none;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.25);
            z-index: 1000;
        }

        .back-btn:hover {
            background: #7c3aed;
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.35);
        }

        .back-btn.active {
            display: flex;
        }

        /* API Setup Section */
        .api-setup {
            background: #ffffff;
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 32px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            display: none;
        }

        .api-setup.active {
            display: block;
        }

        .api-setup h3 {
            color: #1a1a1a;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .api-input-group {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            align-items: center;
        }

        .api-input {
            flex: 1;
            padding: 16px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            transition: border-color 0.2s ease;
        }

        .api-input:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        .api-btn {
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .api-btn-test {
            background: #f8fafc;
            color: #64748b;
            border: 2px solid #e2e8f0;
        }

        .api-btn-test:hover:not(:disabled) {
            background: #f1f5f9;
            border-color: #cbd5e1;
            transform: translateY(-1px);
        }

        .api-btn-save {
            background: #10b981;
            color: white;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.25);
        }

        .api-btn-save:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.35);
        }

        .api-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .api-status {
            padding: 16px 20px;
            border-radius: 12px;
            font-weight: 500;
            margin-top: 16px;
            display: none;
            font-size: 0.9rem;
        }

        .api-status.success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
            display: block;
        }

        .api-status.error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
            display: block;
        }

        .api-status.testing {
            background: #fff7ed;
            color: #ea580c;
            border: 1px solid #fed7aa;
            display: block;
        }

        .progress-bar {
            background: #f1f5f9;
            border-radius: 8px;
            height: 8px;
            margin-bottom: 32px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #8b5cf6, #a855f7);
            height: 100%;
            width: 100%;
            transition: width 0.3s ease;
        }

        .question-counter {
            text-align: center;
            margin-bottom: 24px;
            font-size: 1rem;
            color: #8b5cf6;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .question-card {
            background: #f8fafc;
            border-radius: 12px;
            padding: 32px;
            margin-bottom: 32px;
            border: 1px solid #e2e8f0;
        }

        .question-text {
            font-size: 1.25rem;
            color: #1a1a1a;
            font-weight: 500;
            line-height: 1.6;
            text-align: center;
        }

        .timer-section {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 25px;
            gap: 20px;
        }

        .timer {
            font-size: 2.5rem;
            font-weight: 700;
            color: #8b5cf6;
            padding: 20px 32px;
            background: #faf5ff;
            border-radius: 16px;
            border: 2px solid #e9d5ff;
            min-width: 140px;
            text-align: center;
            letter-spacing: -0.5px;
        }

        .timer.warning {
            color: #ff6b6b;
            border-color: #ff6b6b;
            animation: pulse-warning 1s infinite;
        }

        @keyframes pulse-warning {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 160px;
            min-height: 48px;
            justify-content: center;
            font-family: inherit;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .btn-start {
            background: #8b5cf6;
            color: white;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.25);
        }

        .btn-start:hover:not(:disabled) {
            background: #7c3aed;
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.35);
        }

        .btn-start.recording {
            background: #ef4444;
            animation: pulse 2s infinite;
        }

        .btn-rerecord {
            background: #f8fafc;
            color: #64748b;
            border: 2px solid #e2e8f0;
        }

        .btn-rerecord:hover:not(:disabled) {
            background: #f1f5f9;
            border-color: #cbd5e1;
            transform: translateY(-1px);
        }

        .btn-next {
            background: #10b981;
            color: white;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.25);
        }

        .btn-next:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.35);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .status {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.1rem;
            font-weight: 600;
            min-height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .status.recording {
            color: #f44336;
        }

        .status.ready {
            color: #4CAF50;
        }

        .status.complete {
            color: #007bff;
        }

        .transcript-container {
            flex: 1;
            background: #f8fafc;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 200px;
        }

        .transcript-label {
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 16px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .transcript {
            flex: 1;
            resize: none;
            border: none;
            outline: none;
            font-size: 1rem;
            line-height: 1.6;
            color: #1a1a1a;
            background: transparent;
            font-family: inherit;
            min-height: 120px;
        }

        .wave-indicator {
            display: none;
            justify-content: center;
            align-items: center;
            gap: 3px;
            margin-left: 10px;
        }

        .wave-indicator.active {
            display: flex;
        }

        .wave-bar {
            width: 3px;
            height: 15px;
            background: #f44336;
            border-radius: 3px;
            animation: wave 1.5s ease-in-out infinite;
        }

        .wave-bar:nth-child(2) { animation-delay: 0.1s; }
        .wave-bar:nth-child(3) { animation-delay: 0.2s; }
        .wave-bar:nth-child(4) { animation-delay: 0.3s; }
        .wave-bar:nth-child(5) { animation-delay: 0.4s; }

        @keyframes wave {
            0%, 100% { height: 15px; }
            50% { height: 25px; }
        }

        .completion-screen {
            display: none;
            text-align: center;
            padding: 48px 24px;
        }

        .completion-screen.active {
            display: block;
        }

        .completion-screen h2 {
            color: #1d1b20;
            font-size: 2rem;
            font-weight: 500;
            margin-bottom: 16px;
            letter-spacing: -0.025em;
        }

        .completion-screen p {
            font-size: 1rem;
            color: #49454f;
            margin-bottom: 32px;
            line-height: 1.5;
            font-weight: 400;
        }

        .analysis-btn {
            background: linear-gradient(135deg, #6750a4, #7c4dff);
            color: white;
            padding: 16px 32px;
            border: none;
            border-radius: 24px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 8px;
            display: inline-flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 1px 3px rgba(103, 80, 164, 0.3);
            letter-spacing: 0.1px;
        }

        .analysis-btn:hover:not(:disabled) {
            box-shadow: 0 4px 8px rgba(103, 80, 164, 0.4);
            transform: translateY(-2px);
        }

        .analysis-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .download-btn {
            background: linear-gradient(135deg, #8b5cf6, #a855f7);
            color: white;
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 8px;
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.25);
            letter-spacing: 0.025em;
            font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            min-height: 48px;
        }

        .download-btn:hover {
            background: linear-gradient(135deg, #7c3aed, #9333ea);
            box-shadow: 0 8px 32px rgba(139, 92, 246, 0.4);
            transform: translateY(-2px);
        }

        /* Analysis Results - Updated Design System */
        .analysis-container {
            background: transparent;
            border: none;
            padding: 0;
            margin-top: 48px;
            display: block;
            max-width: 100%;
        }

        .analysis-container.hidden {
            display: none;
        }

        .analysis-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 32px;
            color: #1a1a1a;
            font-size: 1.75rem;
            font-weight: 600;
            letter-spacing: -0.025em;
        }

        .analysis-content {
            padding: 0;
            background: transparent;
            border: none;
            border-radius: 0;
            line-height: 1.6;
            color: #1a1a1a;
        }

        /* Updated Score Cards */
        .score-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 48px;
        }

        .score-card-dashboard {
            background: #ffffff;
            border-radius: 16px;
            padding: 32px 24px;
            text-align: center;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid #f1f5f9;
            position: relative;
            overflow: hidden;
        }

        .score-card-dashboard::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #8b5cf6, #a855f7);
        }

        .score-card-dashboard:hover {
            box-shadow: 0 8px 32px rgba(139, 92, 246, 0.15);
            transform: translateY(-4px);
        }

        .score-card-dashboard.fluency::before {
            background: linear-gradient(90deg, #8b5cf6, #a855f7);
        }

        .score-card-dashboard.grammar::before {
            background: linear-gradient(90deg, #10b981, #059669);
        }

        .score-card-dashboard.overall::before {
            background: linear-gradient(90deg, #3b82f6, #2563eb);
        }

        .score-icon {
            font-size: 2.5rem;
            margin-bottom: 16px;
            opacity: 0.9;
        }

        .score-title {
            font-size: 1rem;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 24px;
            letter-spacing: 0.025em;
            text-transform: uppercase;
        }

        .score-circle {
            width: 120px;
            height: 120px;
            margin: 0 auto 24px;
            position: relative;
        }

        .score-circle svg {
            transform: rotate(-90deg);
        }

        .score-circle-bg {
            fill: none;
            stroke: #f1f5f9;
            stroke-width: 8;
        }

        .score-circle-progress {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
            transition: stroke-dashoffset 2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .score-circle-progress.excellent {
            stroke: #10b981;
        }

        .score-circle-progress.good {
            stroke: #3b82f6;
        }

        .score-circle-progress.fair {
            stroke: #f59e0b;
        }

        .score-circle-progress.poor {
            stroke: #ef4444;
        }

        .score-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            font-weight: 700;
            color: #1a1a1a;
            line-height: 1;
        }

        .score-subtitle {
            font-size: 0.875rem;
            color: #6b7280;
            line-height: 1.4;
            font-weight: 400;
        }

        /* Updated Improvement Tips */
        .improvement-tips {
            background: transparent;
            border-radius: 0;
            padding: 0;
            margin-top: 48px;
        }

        .tips-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 32px;
            font-size: 1.5rem;
            font-weight: 600;
            color: #1a1a1a;
            letter-spacing: -0.025em;
        }

        .tips-grid {
            display: grid;
            gap: 20px;
        }

        .tip-item {
            background: #ffffff;
            border-radius: 16px;
            padding: 24px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            display: flex;
            gap: 20px;
            align-items: flex-start;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tip-item:hover {
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        .tip-number {
            background: linear-gradient(135deg, #8b5cf6, #a855f7);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
            flex-shrink: 0;
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.25);
        }

        .tip-content {
            flex: 1;
        }

        .tip-title {
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 8px;
            font-size: 1rem;
            line-height: 1.4;
        }

        .tip-description {
            color: #6b7280;
            line-height: 1.5;
            font-size: 0.875rem;
            font-weight: 400;
        }

        @media (max-width: 768px) {
            body {
                padding: 16px;
                align-items: flex-start;
            }

            .container {
                padding: 24px 20px;
                margin: 0;
                border-radius: 12px;
                min-height: auto;
                max-width: 100%;
            }

            .header h1 {
                font-size: 2rem;
                margin-bottom: 8px;
                letter-spacing: -0.3px;
            }

            .header p {
                font-size: 1rem;
                margin-bottom: 24px;
            }

            /* Mobile Settings and Back Buttons */
            .settings-btn {
                position: fixed;
                top: 16px;
                right: 16px;
                width: 44px;
                height: 44px;
                font-size: 1.1rem;
                z-index: 1001;
            }

            .back-btn {
                position: fixed;
                top: 16px;
                right: 16px;
                padding: 10px 16px;
                font-size: 0.875rem;
                z-index: 1001;
            }

            /* Mobile Controls */
            .controls {
                flex-direction: column;
                align-items: center;
                gap: 16px;
                margin-bottom: 24px;
            }

            .btn {
                width: 100%;
                max-width: 280px;
                padding: 16px 24px;
                font-size: 1rem;
                border-radius: 12px;
            }

            .timer {
                font-size: 1.5rem;
                padding: 12px 24px;
                margin-bottom: 16px;
                border-radius: 12px;
            }

            /* Mobile API Setup */
            .api-setup {
                padding: 24px 20px;
                margin-bottom: 24px;
                border-radius: 12px;
            }

            .api-setup h3 {
                font-size: 1.25rem;
                margin-bottom: 20px;
            }

            .api-input-group {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }

            .api-input {
                padding: 14px 16px;
                font-size: 16px; /* Prevents zoom on iOS */
                border-radius: 10px;
            }

            .api-btn {
                padding: 14px 20px;
                font-size: 0.9rem;
                border-radius: 10px;
                width: 100%;
            }

            .info-box {
                padding: 16px;
                font-size: 0.875rem;
                border-radius: 10px;
                margin-top: 16px;
            }

            /* Mobile Question Cards */
            .question-card {
                padding: 24px 20px;
                margin-bottom: 20px;
                border-radius: 12px;
            }

            .question-card h3 {
                font-size: 1.125rem;
                margin-bottom: 12px;
            }

            .question-card p {
                font-size: 0.9rem;
                line-height: 1.5;
            }

            /* Mobile Transcript */
            .transcript-container {
                margin: 20px 0;
            }

            .transcript {
                padding: 16px;
                font-size: 0.9rem;
                border-radius: 10px;
                min-height: 120px;
            }

            .word-count {
                font-size: 0.8rem;
                margin-top: 8px;
            }

            /* Mobile Progress */
            .progress-bar {
                height: 6px;
                border-radius: 3px;
            }

            /* Mobile Score Cards */
            .score-cards-container {
                grid-template-columns: 1fr;
                gap: 20px;
                margin-bottom: 32px;
            }

            .score-card-dashboard {
                padding: 24px 20px;
                border-radius: 12px;
            }

            .score-circle {
                width: 100px;
                height: 100px;
                margin-bottom: 20px;
            }

            .score-text {
                font-size: 1.75rem;
            }

            .score-title {
                font-size: 0.9rem;
                margin-bottom: 20px;
            }

            .score-subtitle {
                font-size: 0.8rem;
            }

            /* Mobile Analysis Results */
            .analysis-header {
                font-size: 1.5rem;
                margin-bottom: 24px;
            }

            .analysis-container {
                margin-top: 32px;
            }

            /* Mobile Tips */
            .tips-header {
                font-size: 1.25rem;
                margin-bottom: 24px;
            }

            .improvement-tips {
                margin-top: 32px;
            }

            .tip-item {
                padding: 20px 16px;
                gap: 16px;
                border-radius: 12px;
                flex-direction: column;
                text-align: center;
            }

            .tip-number {
                width: 36px;
                height: 36px;
                font-size: 0.875rem;
                margin: 0 auto 12px;
            }

            .tip-content {
                text-align: left;
            }

            .tip-title {
                font-size: 0.95rem;
                margin-bottom: 8px;
            }

            .tip-description {
                font-size: 0.85rem;
                line-height: 1.4;
            }

            /* Mobile Download Section */
            .download-section {
                padding: 24px 20px;
                margin-top: 32px;
                border-radius: 12px;
            }

            .download-section h3 {
                font-size: 1.125rem;
                margin-bottom: 12px;
            }

            .download-section p {
                font-size: 0.85rem;
                margin-bottom: 24px;
            }

            .download-btn {
                padding: 14px 24px;
                font-size: 0.9rem;
                border-radius: 10px;
                width: 100%;
                max-width: 200px;
            }

            /* Mobile Specific Utilities */
            .mobile-stack {
                flex-direction: column !important;
                gap: 12px !important;
            }

            .mobile-center {
                text-align: center !important;
            }

            .mobile-full-width {
                width: 100% !important;
                max-width: none !important;
            }
        }

        /* Small mobile devices (iPhone SE, etc.) */
        @media (max-width: 480px) {
            body {
                padding: 12px;
            }

            .container {
                padding: 20px 16px;
                border-radius: 8px;
            }

            .header h1 {
                font-size: 1.75rem;
            }

            .header p {
                font-size: 0.95rem;
            }

            .btn {
                padding: 14px 20px;
                font-size: 0.95rem;
            }

            .timer {
                font-size: 1.25rem;
                padding: 10px 20px;
            }

            .question-card {
                padding: 20px 16px;
            }

            .score-card-dashboard {
                padding: 20px 16px;
            }

            .score-circle {
                width: 90px;
                height: 90px;
            }

            .score-text {
                font-size: 1.5rem;
            }

            .tip-item {
                padding: 16px 12px;
            }

            .api-setup {
                padding: 20px 16px;
            }
        }

        /* Landscape orientation on mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            body {
                align-items: flex-start;
                padding-top: 16px;
            }

            .container {
                min-height: auto;
            }

            .score-cards-container {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 16px;
            }

            .tip-item {
                flex-direction: row;
                text-align: left;
            }

            .tip-number {
                margin: 0;
            }
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="back-btn" id="backBtn">
                <span>←</span>
                <span>Back to Assessment</span>
            </button>
            <button class="settings-btn" id="settingsBtn">
                <span>⚙️</span>
            </button>
            <h1>🎤 AI-Powered English Assessment</h1>
            <p>Speak about each topic for 2 minutes and get detailed AI feedback on your performance</p>
        </div>

        <!-- API Setup Section -->
        <div class="api-setup" id="apiSetup">
            <h3>🔑 Claude API Setup</h3>
            <div class="api-input-group">
                <input type="password" class="api-input" id="apiKeyInput" placeholder="Enter your Anthropic API key (sk-ant-...)">
                <button class="api-btn api-btn-test" id="testApiBtn">
                    <span>🧪</span>
                    <span>Test</span>
                </button>
                <button class="api-btn api-btn-save" id="saveApiBtn" disabled>
                    <span>💾</span>
                    <span>Save</span>
                </button>
            </div>
            <div class="api-status" id="apiStatus"></div>
            <div style="margin-top: 24px; padding: 20px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
                <h4 style="margin: 0 0 12px 0; color: #1a1a1a; font-size: 1rem; font-weight: 600;">📝 How to get your API key:</h4>
                <ol style="margin: 0; padding-left: 20px; color: #6b7280; line-height: 1.6;">
                    <li>Visit <a href="https://console.anthropic.com" target="_blank" style="color: #8b5cf6; text-decoration: none; font-weight: 500;">console.anthropic.com</a></li>
                    <li>Sign up or log in to your account</li>
                    <li>Go to API Keys section</li>
                    <li>Create a new API key</li>
                    <li>Copy and paste it above</li>
                </ol>
            </div>
        </div>

        <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <div id="assessmentSection">
            <div class="question-counter" id="questionCounter">Speaking Assessment</div>
            
            <div class="question-card">
                <div class="question-text" id="questionText">Tell me about your daily routine. What does a typical day look like for you?</div>
            </div>

            <div class="timer-section">
                <div class="timer" id="timer">01:00</div>
            </div>

            <div class="controls">
                <button class="btn btn-start" id="startBtn">
                    <span>🎤</span>
                    <span id="startText">Start Recording</span>
                </button>
                <button class="btn btn-rerecord" id="rerecordBtn" disabled>
                    <span>🔄</span>
                    <span>Re-record</span>
                </button>
                <button class="btn btn-next" id="nextBtn" disabled>
                    <span>✓</span>
                    <span>Complete</span>
                </button>
            </div>

            <div class="status" id="status">Set up your API key first, then click "Start Recording" to begin</div>

            <div class="transcript-container">
                <div class="transcript-label">
                    📝 Your Response
                    <div class="wave-indicator" id="waveIndicator">
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                    </div>
                </div>
                <textarea class="transcript" id="transcript" placeholder="Your spoken response will be transcribed here..." readonly></textarea>
            </div>
        </div>

        <div class="completion-screen" id="completionScreen">
            <h2>🎉 Assessment Complete!</h2>
            <p>You have successfully completed your English speaking assessment. Get your AI analysis below!</p>
            <div style="margin: 20px 0;">
                <button class="analysis-btn" id="analyzeBtn">
                    <span>🤖</span>
                    <span>Get AI Analysis</span>
                </button>
                <button class="download-btn" id="downloadBtn">📥 Download Response</button>
            </div>
        </div>
    </div>

    <script>
        class EnglishAssessmentApp {
            constructor() {
                this.questions = [
                    "Tell me about your daily routine and what motivates you in your professional life. Describe your goals and how you plan to achieve them."
                ];
                
                this.currentQuestion = 0;
                this.recognition = null;
                this.isRecording = false;
                this.timer = null;
                this.timeLeft = 60; // Changed to 1 minute
                this.answers = [];
                this.currentTranscript = '';
                this.apiKey = '';
                this.apiKeyValid = false;
                
                // Wait for DOM to be fully loaded
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => this.initialize());
                } else {
                    this.initialize();
                }
            }

            initialize() {
                this.initElements();
                this.initSpeechRecognition();
                this.bindEvents();
                this.updateDisplay();
                this.loadSavedApiKey();
            }

            initElements() {
                // API elements
                this.apiKeyInput = document.getElementById('apiKeyInput');
                this.testApiBtn = document.getElementById('testApiBtn');
                this.saveApiBtn = document.getElementById('saveApiBtn');
                this.apiStatus = document.getElementById('apiStatus');
                
                // Assessment elements
                this.questionCounter = document.getElementById('questionCounter');
                this.questionText = document.getElementById('questionText');
                this.progressFill = document.getElementById('progressFill');
                this.timerDisplay = document.getElementById('timer');
                this.startBtn = document.getElementById('startBtn');
                this.rerecordBtn = document.getElementById('rerecordBtn');
                this.nextBtn = document.getElementById('nextBtn');
                this.transcript = document.getElementById('transcript');
                this.status = document.getElementById('status');
                this.startText = document.getElementById('startText');
                this.waveIndicator = document.getElementById('waveIndicator');
                this.progressBar = document.getElementById('progressBar');
                this.assessmentSection = document.getElementById('assessmentSection');
                this.settingsBtn = document.getElementById('settingsBtn');
                this.backBtn = document.getElementById('backBtn');
                this.completionScreen = document.getElementById('completionScreen');
                this.downloadBtn = document.getElementById('downloadBtn');
                this.analyzeBtn = document.getElementById('analyzeBtn');
                this.analysisContainer = document.getElementById('analysisContainer');
                this.analysisContent = document.getElementById('analysisContent');
            }

            initSpeechRecognition() {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    this.showError('Speech recognition not supported in this browser. Please use Chrome, Edge, or Safari.');
                    return;
                }

                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.recognition = new SpeechRecognition();
                
                this.recognition.continuous = true;
                this.recognition.interimResults = true;
                this.recognition.lang = 'en-US';

                this.recognition.onstart = () => {
                    this.isRecording = true;
                    this.updateUI();
                    this.setStatus('Recording... Speak clearly!', 'recording');
                    this.startTimer();
                };

                this.recognition.onresult = (event) => {
                    let interimTranscript = '';
                    let finalTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript + ' ';
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    this.currentTranscript += finalTranscript;
                    this.transcript.value = this.currentTranscript + interimTranscript;
                    this.transcript.scrollTop = this.transcript.scrollHeight;
                };

                this.recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    this.handleRecognitionError(event.error);
                };

                this.recognition.onend = () => {
                    if (this.isRecording && this.timeLeft > 0) {
                        setTimeout(() => {
                            if (this.isRecording) {
                                try {
                                    this.recognition.start();
                                } catch (error) {
                                    console.error('Error restarting recognition:', error);
                                }
                            }
                        }, 100);
                    }
                };
            }

            bindEvents() {
                // Navigation events
                this.settingsBtn.addEventListener('click', () => {
                    this.showSettings();
                });
                this.backBtn.addEventListener('click', () => {
                    this.showAssessment();
                });
                
                // API events
                this.testApiBtn.addEventListener('click', () => this.testApiKey());
                this.saveApiBtn.addEventListener('click', () => this.saveApiKey());
                this.apiKeyInput.addEventListener('input', () => this.onApiKeyInput());
                
                // Assessment events
                this.startBtn.addEventListener('click', () => this.toggleRecording());
                this.rerecordBtn.addEventListener('click', () => this.rerecordQuestion());
                this.nextBtn.addEventListener('click', () => this.completeAssessment());
                this.downloadBtn.addEventListener('click', () => this.downloadAnswers());
                this.analyzeBtn.addEventListener('click', () => this.analyzeWithClaude());

                document.addEventListener('click', this.requestMicPermission.bind(this), { once: true });
            }

            showSettings() {
                const apiSetup = document.getElementById('apiSetup');
                const progressBar = document.getElementById('progressBar');
                const assessmentSection = document.getElementById('assessmentSection');
                const completionScreen = document.getElementById('completionScreen');
                const settingsBtn = document.getElementById('settingsBtn');
                const backBtn = document.getElementById('backBtn');
                
                if (apiSetup) apiSetup.style.display = 'block';
                if (progressBar) progressBar.style.display = 'none';
                if (assessmentSection) assessmentSection.style.display = 'none';
                if (completionScreen) completionScreen.style.display = 'none';
                if (settingsBtn) settingsBtn.style.display = 'none';
                if (backBtn) backBtn.style.display = 'flex';
            }

            showAssessment() {
                const apiSetup = document.getElementById('apiSetup');
                const progressBar = document.getElementById('progressBar');
                const assessmentSection = document.getElementById('assessmentSection');
                const settingsBtn = document.getElementById('settingsBtn');
                const backBtn = document.getElementById('backBtn');
                
                if (apiSetup) apiSetup.style.display = 'none';
                if (progressBar) progressBar.style.display = 'block';
                if (assessmentSection) assessmentSection.style.display = 'block';
                if (settingsBtn) settingsBtn.style.display = 'flex';
                if (backBtn) backBtn.style.display = 'none';
                
                // If assessment is completed, show completion screen
                if (this.currentQuestion >= this.questions.length) {
                    this.showCompletion();
                }
            }

            // API Key Management
            onApiKeyInput() {
                const value = this.apiKeyInput.value.trim();
                this.testApiBtn.disabled = !value;
                this.saveApiBtn.disabled = true;
                this.apiKeyValid = false;
                this.hideApiStatus();
            }

            async testApiKey() {
                const apiKey = this.apiKeyInput.value.trim();
                if (!apiKey) return;

                this.showApiStatus('Testing API key with Claude 4 Sonnet...', 'testing');
                this.testApiBtn.disabled = true;

                // Debug API key format like in code.ts
                console.log('🔑 API key length:', apiKey.length);
                console.log('🔑 API key starts with:', apiKey.substring(0, 15) + '...');
                console.log('🔑 API key contains non-ASCII:', /[^\x00-\x7F]/.test(apiKey));

                try {
                    console.log('🧪 Testing API key with Claude 4 Sonnet...');
                    
                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': apiKey,
                            'anthropic-version': '2023-06-01',
                            'anthropic-dangerous-direct-browser-access': 'true'
                        },
                        body: JSON.stringify({
                            model: 'claude-3-haiku-20240307', // Test with Claude 4 Sonnet
                            max_tokens: 10,
                            messages: [
                                { role: 'user', content: 'Hello' }
                            ]
                        })
                    });

                    console.log('🔍 Test response status:', response.status);

                    if (response.ok) {
                        this.apiKeyValid = true;
                        this.saveApiBtn.disabled = false;
                        this.showApiStatus('✅ API key is valid and working with Claude 4 Sonnet!', 'success');
                        console.log('✅ API key test successful with Claude 4 Sonnet');
                    } else {
                        const errorText = await response.text();
                        console.error('❌ API key test failed:', errorText);
                        this.showApiStatus(`❌ API key test failed: ${errorText}`, 'error');
                    }
                } catch (error) {
                    console.error('API test error:', error);
                    // Handle CORS error gracefully - fallback to format validation
                    if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
                        // For demo purposes, if the API key looks valid, allow it
                        if (apiKey.startsWith('sk-ant-') && apiKey.length > 20) {
                            this.apiKeyValid = true;
                            this.saveApiBtn.disabled = false;
                            this.showApiStatus('⚠️ Cannot test due to CORS, but API key format looks valid. Analysis will be attempted.', 'success');
                        } else {
                            this.showApiStatus('❌ Invalid API key format. Should start with "sk-ant-"', 'error');
                        }
                    } else {
                        this.showApiStatus(`❌ Connection error: ${error.message}`, 'error');
                    }
                }

                this.testApiBtn.disabled = false;
            }

            saveApiKey() {
                if (!this.apiKeyValid) return;
                
                this.apiKey = this.apiKeyInput.value.trim();
                localStorage.setItem('anthropic_api_key', this.apiKey);
                this.showApiStatus('✅ API key saved successfully!', 'success');
                this.updateAssessmentStatus();
            }

            loadSavedApiKey() {
                const savedKey = localStorage.getItem('anthropic_api_key');
                if (savedKey) {
                    this.apiKeyInput.value = savedKey;
                    this.apiKey = savedKey;
                    this.apiKeyValid = true;
                    this.showApiStatus('✅ Saved API key loaded', 'success');
                    this.updateAssessmentStatus();
                }
            }

            showApiStatus(message, type) {
                this.apiStatus.textContent = message;
                this.apiStatus.className = `api-status ${type}`;
            }

            hideApiStatus() {
                this.apiStatus.className = 'api-status';
            }

            updateAssessmentStatus() {
                if (this.apiKeyValid) {
                    this.setStatus('Ready to start your English assessment!', 'ready');
                } else {
                    this.setStatus('Set up your API key first, then click "Start Recording" to begin', '');
                }
            }

            // Assessment Methods
            async requestMicPermission() {
                try {
                    await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.updateAssessmentStatus();
                } catch (error) {
                    this.showError('Microphone access is required for this assessment.');
                }
            }

            toggleRecording() {
                if (!this.apiKeyValid) {
                    this.showError('Please set up and test your API key first.');
                    return;
                }

                if (!this.recognition) {
                    this.showError('Speech recognition not available');
                    return;
                }

                if (this.isRecording) {
                    this.stopRecording();
                } else {
                    this.startRecording();
                }
            }

            startRecording() {
                this.timeLeft = 60; // 1 minute
                this.updateTimer();
                
                try {
                    this.recognition.start();
                    this.startBtn.classList.add('recording');
                    this.startText.textContent = 'Stop Recording';
                    this.waveIndicator.classList.add('active');
                } catch (error) {
                    console.error('Error starting recognition:', error);
                    this.showError('Failed to start recording');
                }
            }

            stopRecording() {
                if (this.recognition) {
                    this.recognition.stop();
                }
                
                this.isRecording = false;
                this.stopTimer();
                this.startBtn.classList.remove('recording');
                this.startText.textContent = 'Start Recording';
                this.waveIndicator.classList.remove('active');
                this.updateUI();
                this.setStatus('Recording completed', 'complete');
                
                // Save answer immediately when recording stops
                if (this.transcript.value.trim()) {
                    this.answers[this.currentQuestion] = {
                        question: this.questions[this.currentQuestion],
                        answer: this.transcript.value.trim(),
                        timestamp: new Date().toISOString(),
                        duration: 60 - this.timeLeft,
                        questionIndex: this.currentQuestion
                    };
                    
                    console.log(`💾 Saved answer:`, this.answers[this.currentQuestion]);
                }
            }

            rerecordQuestion() {
                this.currentTranscript = '';
                this.transcript.value = '';
                this.timeLeft = 60;
                this.updateTimer();
                this.updateUI();
                this.setStatus('Ready to re-record', 'ready');
            }

            completeAssessment() {
                // Save current answer with proper metadata
                this.answers[this.currentQuestion] = {
                    question: this.questions[this.currentQuestion],
                    answer: this.transcript.value.trim(),
                    timestamp: new Date().toISOString(),
                    duration: 60 - this.timeLeft,
                    questionIndex: this.currentQuestion
                };

                this.showCompletion();
            }

            startTimer() {
                this.timer = setInterval(() => {
                    this.timeLeft--;
                    this.updateTimer();
                    
                    if (this.timeLeft <= 15) {
                        this.timerDisplay.classList.add('warning');
                    }
                    
                    if (this.timeLeft <= 0) {
                        this.stopRecording();
                        this.setStatus('Time\'s up! You can re-record or complete the assessment.', 'complete');
                    }
                }, 1000);
            }

            stopTimer() {
                if (this.timer) {
                    clearInterval(this.timer);
                    this.timer = null;
                }
                this.timerDisplay.classList.remove('warning');
            }

            updateTimer() {
                const minutes = Math.floor(this.timeLeft / 60);
                const seconds = this.timeLeft % 60;
                this.timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            updateDisplay() {
                this.questionCounter.textContent = 'Speaking Assessment';
                this.questionText.textContent = this.questions[this.currentQuestion];
                
                // Always show 100% progress since it's a single question
                this.progressFill.style.width = '100%';
            }

            updateUI() {
                this.startBtn.disabled = !this.apiKeyValid;
                this.rerecordBtn.disabled = this.isRecording || !this.transcript.value.trim();
                this.nextBtn.disabled = this.isRecording || !this.transcript.value.trim();
            }

            showCompletion() {
                console.log('🎯 Showing completion screen');
                console.log('📊 Total answers collected:', this.answers.length);
                console.log('📝 Answers:', this.answers);
                
                // Hide assessment section and progress bar
                this.assessmentSection.style.display = 'none';
                this.progressBar.style.display = 'none';
                
                // Show completion screen
                this.completionScreen.style.display = 'block';
                this.completionScreen.classList.add('active');
                
                // Set progress to 100%
                this.progressFill.style.width = '100%';
                
                // Make sure analyze button is visible and enabled
                const analyzeBtn = document.getElementById('analyzeBtn');
                const downloadBtn = document.getElementById('downloadBtn');
                
                if (analyzeBtn) {
                    analyzeBtn.style.display = 'inline-flex';
                    analyzeBtn.disabled = false;
                    console.log('✅ Analyze button is now visible and enabled');
                }
                
                if (downloadBtn) {
                    downloadBtn.style.display = 'inline-flex';
                    downloadBtn.disabled = false;
                }
            }

            downloadAnswers() {
                // Create comprehensive JSON structure for single question
                const assessmentData = {
                    metadata: {
                        assessmentId: `assessment_${Date.now()}`,
                        completedAt: new Date().toISOString(),
                        totalQuestions: 1,
                        language: 'en-US',
                        version: '2.0',
                        duration: 60
                    },
                    response: this.answers[0] || {
                        question: this.questions[0],
                        answer: '',
                        timestamp: new Date().toISOString(),
                        duration: 0,
                        questionIndex: 0
                    },
                    summary: {
                        totalResponses: this.answers.length,
                        totalSpeakingTime: this.answers[0]?.duration || 0,
                        totalWords: this.answers[0]?.answer ? this.answers[0].answer.split(' ').length : 0,
                        averageWordsPerMinute: this.answers[0]?.duration > 0 ? 
                            Math.round((this.answers[0].answer.split(' ').length / (this.answers[0].duration / 60))) : 0
                    }
                };
                
                // Download JSON file
                const jsonBlob = new Blob([JSON.stringify(assessmentData, null, 2)], { type: 'application/json' });
                const jsonUrl = URL.createObjectURL(jsonBlob);
                const jsonLink = document.createElement('a');
                jsonLink.href = jsonUrl;
                jsonLink.download = `english-assessment-${Date.now()}.json`;
                document.body.appendChild(jsonLink);
                jsonLink.click();
                document.body.removeChild(jsonLink);
                URL.revokeObjectURL(jsonUrl);
                
                // Also download text file for readability
                const answer = this.answers[0];
                const textContent = answer ? 
                    `English Speaking Assessment\n\nQuestion: ${answer.question}\n\nResponse: ${answer.answer}\nDuration: ${answer.duration || 0}s\nWord Count: ${answer.answer ? answer.answer.split(' ').length : 0}\nTimestamp: ${answer.timestamp}\n\n${'='.repeat(50)}\n\n` :
                    'No assessment data available.\n';
                
                const textBlob = new Blob([textContent], { type: 'text/plain' });
                const textUrl = URL.createObjectURL(textBlob);
                const textLink = document.createElement('a');
                textLink.href = textUrl;
                textLink.download = `english-assessment-${Date.now()}.txt`;
                document.body.appendChild(textLink);
                textLink.click();
                document.body.removeChild(textLink);
                URL.revokeObjectURL(textUrl);
            }

            async analyzeWithClaude() {
                if (!this.apiKeyValid || !this.apiKey) {
                    this.showError('API key is required for analysis.');
                    return;
                }

                // Show loading screen
                this.showLoadingScreen();

                try {
                    // Create comprehensive JSON payload
                    const assessmentData = {
                        metadata: {
                            assessmentId: `assessment_${Date.now()}`,
                            completedAt: new Date().toISOString(),
                            totalQuestions: this.questions.length,
                            language: 'en-US',
                            version: '1.0'
                        },
                        responses: this.answers,
                        summary: {
                            totalResponses: this.answers.length,
                            totalSpeakingTime: this.answers.reduce((total, answer) => total + (answer.duration || 0), 0),
                            averageResponseLength: Math.round(
                                this.answers.reduce((total, answer) => total + (answer.answer?.length || 0), 0) / this.answers.length
                            )
                        }
                    };

                    console.log('🔄 Sending assessment data to Claude for analysis...');
                    console.log('📊 Assessment Data:', assessmentData);
                    
                    const analysisPrompt = this.createClaudeAnalysisPrompt(assessmentData);
                    
                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': this.apiKey,
                            'anthropic-version': '2023-06-01',
                            'anthropic-dangerous-direct-browser-access': 'true'
                        },
                        body: JSON.stringify({
                            model: 'claude-sonnet-4-20250514',
                            max_tokens: 2000,
                            temperature: 0.3,
                            system: `You are an expert English language assessor. Analyze the provided speaking assessment data and respond with ONLY valid JSON in the exact format requested. Do not include any other text, explanations, or markdown formatting.`,
                            messages: [
                                { role: 'user', content: analysisPrompt }
                            ]
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const analysis = result.content[0].text;
                        console.log('✅ Received Claude response');
                        this.hideLoadingScreen();
                        
                        // Try to parse as JSON first, then display as cards
                        this.displayAnalysisResults(analysis);
                        
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        console.error('❌ API error:', errorData);
                        throw new Error(errorData.error?.message || `HTTP ${response.status}`);
                    }
                    
                } catch (error) {
                    console.error('❌ Analysis error:', error);
                    this.hideLoadingScreen();
                    
                    // Always show demo analysis in case of error
                    console.log('🔄 Showing demo analysis due to error');
                    this.displayDemoAnalysis();
                }
            }

            createClaudeAnalysisPrompt(assessmentData) {
                // Create the complete transcript data as requested
                const transcriptJSON = {
                    metadata: {
                        assessmentId: assessmentData.metadata.assessmentId,
                        completedAt: assessmentData.metadata.completedAt,
                        totalQuestions: 1,
                        language: assessmentData.metadata.language,
                        version: assessmentData.metadata.version,
                        duration: 60
                    },
                    response: {
                        questionIndex: 0,
                        question: assessmentData.responses[0]?.question || this.questions[0],
                        answer: assessmentData.responses[0]?.answer || '',
                        timestamp: assessmentData.responses[0]?.timestamp || new Date().toISOString(),
                        duration: assessmentData.responses[0]?.duration || 0,
                        wordCount: assessmentData.responses[0]?.answer ? assessmentData.responses[0].answer.split(' ').length : 0
                    },
                    summary: {
                        totalResponses: 1,
                        totalSpeakingTime: assessmentData.responses[0]?.duration || 0,
                        totalWords: assessmentData.responses[0]?.answer ? assessmentData.responses[0].answer.split(' ').length : 0,
                        averageWordsPerMinute: assessmentData.responses[0]?.duration > 0 ? 
                            Math.round((assessmentData.responses[0].answer.split(' ').length / (assessmentData.responses[0].duration / 60))) : 0
                    }
                };
                
                return `Please analyze this English speaking assessment and provide scores for only these 3 categories:

Assessment Data:
${JSON.stringify(transcriptJSON, null, 2)}

Analyze the responses and provide:

1. **Fluency Score** (1-10): How smooth and natural is the speech flow? Consider pace, pauses, hesitations, and overall delivery.

2. **Grammar Score** (1-10): How accurate is the grammar usage? Consider verb tenses, sentence structure, and grammatical correctness.

3. **Overall Score** (1-10): The general effectiveness of communication combining all aspects.

Also provide 3 specific, actionable improvement tips based on the analysis.

Respond with ONLY a JSON object in this exact format:
{
  "fluency": {
    "score": 0,
    "description": "brief explanation of score"
  },
  "grammar": {
    "score": 0,
    "description": "brief explanation of score"
  },
  "overall": {
    "score": 0,
    "description": "brief explanation of score"
  },
  "improvementTips": [
    {
      "title": "Tip title",
      "description": "Specific actionable advice"
    },
    {
      "title": "Tip title",  
      "description": "Specific actionable advice"
    },
    {
      "title": "Tip title",
      "description": "Specific actionable advice"
    }
  ]
}`;
            }

            displayAnalysisResults(analysis) {
                // Ensure loading screen is hidden
                this.hideLoadingScreen();
                
                try {
                    // Try to parse as JSON
                    const analysisData = JSON.parse(analysis);
                    this.displayScoreCards(analysisData);
                } catch (error) {
                    // If not JSON, try to display as formatted text
                    console.warn('Could not parse analysis as JSON, displaying as text');
                    this.displayFormattedAnalysis(analysis);
                }
            }

            displayScoreCards(data) {
                const getScoreClass = (score) => {
                    if (score >= 8) return 'excellent';
                    if (score >= 6) return 'good';
                    if (score >= 4) return 'fair';
                    return 'poor';
                };

                const createCircleProgress = (score, scoreClass) => {
                    const circumference = 2 * Math.PI * 54;
                    const offset = circumference - (score / 10) * circumference;
                    
                    return `
                        <svg width="120" height="120">
                            <circle cx="60" cy="60" r="54" class="score-circle-bg"></circle>
                            <circle cx="60" cy="60" r="54" class="score-circle-progress ${scoreClass}"
                                stroke-dasharray="${circumference}"
                                stroke-dashoffset="${offset}">
                            </circle>
                        </svg>
                        <div class="score-text">${score}</div>
                    `;
                };

                // Material Design 3 Clean Dashboard
                const html = `
                    <div class="analysis-header">
                        <span>📊</span>
                        <span>Assessment Results</span>
                    </div>
                    
                    <div class="score-cards-container">
                        <div class="score-card-dashboard fluency">
                            <div class="score-icon">🗣️</div>
                            <div class="score-title">Fluency</div>
                            <div class="score-circle">
                                ${createCircleProgress(data.fluency.score, getScoreClass(data.fluency.score))}
                            </div>
                            <div class="score-subtitle">${data.fluency.description || 'Speech flow and delivery'}</div>
                        </div>
                        
                        <div class="score-card-dashboard grammar">
                            <div class="score-icon">📝</div>
                            <div class="score-title">Grammar</div>
                            <div class="score-circle">
                                ${createCircleProgress(data.grammar.score, getScoreClass(data.grammar.score))}
                            </div>
                            <div class="score-subtitle">${data.grammar.description || 'Language accuracy'}</div>
                        </div>
                        
                        <div class="score-card-dashboard overall">
                            <div class="score-icon">💬</div>
                            <div class="score-title">Overall</div>
                            <div class="score-circle">
                                ${createCircleProgress(data.overall.score, getScoreClass(data.overall.score))}
                            </div>
                            <div class="score-subtitle">${data.overall.description || 'Total performance'}</div>
                        </div>
                    </div>
                    
                    <div class="improvement-tips">
                        <div class="tips-header">
                            <span>💡</span>
                            <span>Tips for Improvement</span>
                        </div>
                        <div class="tips-grid">
                            ${data.improvementTips && data.improvementTips.length > 0 ? 
                                data.improvementTips.map((tip, index) => `
                                    <div class="tip-item">
                                        <div class="tip-number">${index + 1}</div>
                                        <div class="tip-content">
                                            <div class="tip-title">${tip.title}</div>
                                            <div class="tip-description">${tip.description}</div>
                                        </div>
                                    </div>
                                `).join('') : 
                                `
                                    <div class="tip-item">
                                        <div class="tip-number">1</div>
                                        <div class="tip-content">
                                            <div class="tip-title">Practice Daily Conversation</div>
                                            <div class="tip-description">Engage in English conversations daily, even if it's just talking to yourself about your day. This helps build fluency and confidence.</div>
                                        </div>
                                    </div>
                                    <div class="tip-item">
                                        <div class="tip-number">2</div>
                                        <div class="tip-content">
                                            <div class="tip-title">Focus on Grammar Patterns</div>
                                            <div class="tip-description">Identify common grammar mistakes and practice correct patterns. Use grammar exercises to reinforce proper usage.</div>
                                        </div>
                                    </div>
                                    <div class="tip-item">
                                        <div class="tip-number">3</div>
                                        <div class="tip-content">
                                            <div class="tip-title">Expand Your Vocabulary</div>
                                            <div class="tip-description">Learn 5 new words daily and practice using them in sentences. This will help you express ideas more precisely.</div>
                                        </div>
                                    </div>
                                `
                            }
                        </div>
                    </div>
                `;
                
                // Directly replace the analysis container content, removing nested boxes
                const analysisContainer = document.getElementById('analysisContainer');
                const completionScreen = document.getElementById('completionScreen');
                
                // Remove analysis container and inject directly into completion screen
                if (analysisContainer) {
                    analysisContainer.remove();
                }
                
                if (completionScreen) {
                    completionScreen.insertAdjacentHTML('beforeend', html);
                }
            }

            displayFormattedAnalysis(analysis) {
                // Format the analysis with proper HTML structure
                const formattedAnalysis = analysis
                    .replace(/## (.*?)(?=\n|$)/g, '<h3 style="color: #667eea; margin: 20px 0 10px 0; font-size: 1.2em;">$1</h3>')
                    .replace(/### (.*?)(?=\n|$)/g, '<h4 style="color: #495057; margin: 15px 0 8px 0; font-size: 1.1em;">$1</h4>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n- /g, '\n• ')
                    .replace(/\n/g, '<br>')
                    .replace(/•/g, '<span style="color: #667eea;">•</span>');

                this.analysisContent.innerHTML = `
                    <div style="line-height: 1.6;">
                        ${formattedAnalysis}
                    </div>
                `;
            }

            showLoadingScreen() {
                // Hide analyze button and show loading
                this.analyzeBtn.style.display = 'none';
                
                // Show loading state directly in completion screen
                const completionScreen = document.getElementById('completionScreen');
                
                if (completionScreen) {
                    const loadingHTML = `
                        <div style="margin-top: 48px; text-align: center; padding: 40px;">
                            <div style="display: inline-block; width: 50px; height: 50px; border: 4px solid #e7e0ec; border-top: 4px solid #6750a4; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 24px;"></div>
                            <h3 style="color: #1d1b20; margin: 24px 0 16px 0; font-weight: 500; font-size: 1.25rem;">🤖 Analyzing Your Assessment</h3>
                            <p style="color: #49454f; margin: 0; font-size: 0.875rem; line-height: 1.4;">Processing your responses and generating detailed feedback...</p>
                        </div>
                        <style>
                            @keyframes spin {
                                0% { transform: rotate(0deg); }
                                100% { transform: rotate(360deg); }
                            }
                        </style>
                    `;
                    
                    completionScreen.insertAdjacentHTML('beforeend', loadingHTML);
                }
            }

            hideLoadingScreen() {
                console.log('✅ Hiding loading screen, showing analyze button');
                
                // Remove loading content from completion screen
                const completionScreen = document.getElementById('completionScreen');
                if (completionScreen) {
                    // Find and remove any loading elements
                    const loadingElements = completionScreen.querySelectorAll('[style*="animation: spin"]');
                    loadingElements.forEach(element => {
                        // Remove the entire loading container (parent div)
                        const loadingContainer = element.closest('div[style*="margin-top: 48px"]');
                        if (loadingContainer) {
                            loadingContainer.remove();
                        }
                    });
                    
                    // Also remove any style tags with spin animation
                    const styleElements = completionScreen.querySelectorAll('style');
                    styleElements.forEach(style => {
                        if (style.textContent.includes('@keyframes spin')) {
                            style.remove();
                        }
                    });
                }
                
                // Show analyze button again
                const analyzeBtn = document.getElementById('analyzeBtn');
                if (analyzeBtn) {
                    analyzeBtn.style.display = 'inline-flex';
                }
            }

            displayDemoAnalysis() {
                // Ensure loading screen is hidden
                this.hideLoadingScreen();
                
                const demoData = {
                    fluency: {
                        score: 7,
                        description: "Good conversational flow with natural pauses"
                    },
                    grammar: {
                        score: 8,
                        description: "Strong grammatical accuracy overall"
                    },
                    overall: {
                        score: 7,
                        description: "Effective communication skills"
                    },
                    improvementTips: [
                        {
                            title: "Practice Speaking Continuously",
                            description: "Work on maintaining a steady flow of speech without long pauses. Try recording yourself speaking for 2 minutes without stopping about familiar topics."
                        },
                        {
                            title: "Expand Your Vocabulary",
                            description: "Learn synonyms for common words you use frequently. This will help you express ideas more precisely and avoid repetition in your speech."
                        },
                        {
                            title: "Focus on Pronunciation",
                            description: "Pay attention to word stress and intonation patterns. Listen to native speakers and practice mimicking their rhythm and pronunciation."
                        }
                    ]
                };
                
                this.displayScoreCards(demoData);
                
                // Add demo notice directly to completion screen
                const completionScreen = document.getElementById('completionScreen');
                if (completionScreen) {
                    const demoNotice = `
                        <div style="background: #fff8e1; padding: 16px; border-radius: 12px; margin-top: 24px; border: 1px solid #ffecb3;">
                            <p style="margin: 0; color: #e65100; font-size: 0.875rem; line-height: 1.4;"><strong>💡 Demo Results:</strong> Due to browser limitations, this shows sample analysis results. For real AI analysis, use a valid API key or deploy with proper backend support.</p>
                        </div>
                    `;
                    
                    completionScreen.insertAdjacentHTML('beforeend', demoNotice);
                }
            }

            setStatus(message, type = '') {
                this.status.textContent = message;
                this.status.className = `status ${type}`;
            }

            showError(message) {
                this.setStatus(message, 'error');
                setTimeout(() => {
                    if (!this.isRecording) {
                        this.updateAssessmentStatus();
                    }
                }, 3000);
            }

            handleRecognitionError(error) {
                let errorMessage = 'Recognition error: ';
                
                switch(error) {
                    case 'no-speech':
                        errorMessage += 'No speech detected. Please try again.';
                        break;
                    case 'audio-capture':
                        errorMessage += 'Microphone not available.';
                        break;
                    case 'not-allowed':
                        errorMessage += 'Microphone access denied.';
                        break;
                    case 'network':
                        errorMessage += 'Network error occurred.';
                        break;
                    default:
                        errorMessage += error;
                }
                
                this.showError(errorMessage);
                this.stopRecording();
            }
        }

        // Initialize the app when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing app');
            new EnglishAssessmentApp();
        });
    </script>
</body>
</html>